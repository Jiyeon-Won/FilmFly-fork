<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>FilmFly</title>
  <!-- 부트 스트랩 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
        rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
        crossorigin="anonymous">
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <!-- 공통 헤더 -->
  <script src="../js/common.js"></script>
  <!-- Font Awesome -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
  <script src="../js/apiModule.js"></script>
  <script src="../js/jquery.twbsPagination.js"></script>

  <link rel="stylesheet" href="../css/reset.css">
  <link rel="stylesheet" href="../css/style.css">
  <style>
    .card {
      position: relative;
    }
    .delete-icon {
      position: absolute;
      top: 10px;
      right: 10px;
      color: red;
      cursor: pointer;
    }
  </style>
</head>
<body>
<div class="container">
  <!-- 공통 헤더 -->
  <header id="common-header"></header>

  <div class="page-title">찜한 영화 목록</div>
  <div id="favorite-movie-box" class="row row-cols-1 row-cols-md-3 g-4">
  </div>
  <ul id="pagination-favorites" class="pagination-sm d-flex justify-content-center mt-4"></ul>
</div>

<script>
  const urlParams = new URLSearchParams(window.location.search);
  const userId = urlParams.get('user');
  console.log("user id : " + userId);

  $(document).ready(function () {
    if(userId == null) {
      alert("user 누락! 페이지 오류!");
      window.history.back();
    }
    loadFavorites(1);
  });

  function loadFavorites(page) {
    // API 호출
    apiModule.GET("/favorites/users/" + userId + "?page=" + page,
            function(result) {
              if (result.statusCode === 200) {
                const movies = result.data.data;
                $('#favorite-movie-box').empty();
                movies.forEach(movie => {
                  const movieHtml = generateMovieHtml(movie);
                  $('#favorite-movie-box').append(movieHtml);
                });

                $('#pagination-favorites').twbsPagination('destroy');
                $('#pagination-favorites').twbsPagination({
                  totalPages: result.data.totalPages,
                  startPage: page,
                  initiateStartPageClick: false,
                  onPageClick: function (event, page) {
                    loadFavorites(page);
                    $('html, body').animate({
                      scrollTop: $('#favorite-movie-box').offset().top
                    }, 'fast');
                  }
                });
              } else {
                alert("찜한 영화를 불러오는 데 실패했습니다.");
              }
            }, function() {
              alert("서버 오류가 발생했습니다.");
            });
  }

  function truncateText(text, maxLength) {
    if (text.length > maxLength) {
      return text.substring(0, maxLength) + '...';
    }
    return text;
  }

  function generateMovieHtml(movie) {
    const maxLength = 100; // 원하는 최대 글자 수 설정
    const truncatedOverview = truncateText(movie.overview, maxLength);
    return `
    <div class="col" data-movie-id="${movie.id}">
      <div class="card h-100">
        <img src="https://image.tmdb.org/t/p/w500${movie.posterPath}" class="card-img-top" alt="영화 포스터">
        <i class="fa-solid fa-trash-can delete-icon" style="font-size: 30px;" data-movie-id="${movie.id}"></i>
        <div class="card-body">
          <h5 class="card-title mypage-entity-title">${movie.title}</h5>
          <p class="card-text"><small class="text-muted">개봉일: ${movie.releaseDate}</small></p>
          <br/>
          <p class="card-text">${truncatedOverview}</p>
        </div>
      </div>
    </div>
    `;
  }

  $(document).on('click', '.col', function(e) {
    if ($(e.target).hasClass('delete-icon')) {
      return;
    }
    const movieId = $(this).attr('data-movie-id');
    const url = `../html/movie-detail.html?movie=${movieId}`;
    location.href = url;
  });

  $(document).on('click', '.delete-icon', function(e) {
    e.stopPropagation();
    const movieId = $(this).data('movie-id');
    if (confirm("해당 영화를 찜 목록에서 삭제하시겠습니까?")) {
      apiModule.DELETE(`/favorites/movies/${movieId}`, function(result) {
        if (result.statusCode === 200) {
          alert("영화가 삭제되었습니다.");
          $(`[data-movie-id="${movieId}"]`).remove();
        } else {
          alert("영화 삭제 실패");
        }
      }, function() {
        alert("서버 오류가 발생했습니다.");
      });
    }
  });
</script>
</body>
</html>
