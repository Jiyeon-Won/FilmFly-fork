<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>FilmFly</title>
  <!-- 부트 스트랩 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
        rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
        crossorigin="anonymous">
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <!-- 공통 헤더 -->
  <script src="../js/common.js"></script>
  <!-- Font Awesome -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">

  <link rel="stylesheet" href="../css/reset.css">
  <link rel="stylesheet" href="../css/style.css">
</head>
<body>
<div class="auth-form">
  <form id="auth-form">
    <h2>Sign Up</h2>
    <label for="username">username</label>
    <div class="input-group mb-3">
      <input type="text" id="username" class="form-control" placeholder="아이디" required>
    </div>

    <label for="password">password</label>
    <div class="input-group mb-3">
      <input type="password" id="password" class="form-control" placeholder="비밀번호" required>
    </div>

    <label for="nickname">닉네임</label>
    <div class="input-group mb-3">
      <input type="text" class="form-control" id="nickname" placeholder="닉네임 입력">
      <button type="button" class="btn btn-secondary" onclick="checkNickname()">중복 확인</button>
      <div id="nicknameFeedback" class="mt-2"></div>
    </div>

    <label for="email">이메일</label>
    <div class="input-group mb-3">
      <input type="text" class="form-control" id="email" placeholder="email 입력">
      <button type="button" class="btn btn-secondary" onclick="sendEmail()">인증번호 전송</button>
      <div id="emailFeedback" class="mt-2"></div>
    </div>

    <label for="emailCheck">
      인증번호 입력 -
      <span id="countDown">3:00</span>
      <span id="feedbackResult"></span>
    </label>
    <div class="input-group mb-3">
      <input type="text" class="form-control" id="emailCheck" placeholder="인증번호 입력">
      <button type="button" class="btn btn-secondary" onclick="checkEmail()">인증번호 확인</button>
      <div id="inputEmailCheck" class="mt-2"></div>
    </div>

    <div>
      <div style="margin-bottom: 10px;">
        <label for="adminCheck">관리자 로그인</label>
        <input type="checkbox" id="adminCheck" name="adminCheck">
      </div>
      <div id="adminPasswordForm" style="display: none">
        <label for="adminPassword">관리자 암호</label>
        <div class="input-group mb-3">
          <input type="password" id="adminPassword" class="form-control" placeholder="관리자 암호" required>
        </div>
      </div>
    </div>

    <button type="button" id="btnSignup" class="btn btn-primary">회원가입</button>
    <button type="button" class="btn btn-primary"
            onclick="location.href='./login.html'">로그인 하러 가기
    </button>
  </form>
</div>

<script>
  let flagNickname = false;
  let intervalCall; // intervalCall 변수를 전역으로 이동
  let feedbackResult = false;

  $('#btnSignup').on('click', function () {
    if (!flagNickname) {
      alert("닉네임 중복체크를 해주세요");
      return;
    }
    const username = $('#username').val();
    const password = $('#password').val();
    const adminPassword = $('#adminPassword').val();

    const data = {
      username: username,
      password: password
    };

    $.ajax({
      type: 'POST',
      url: '',
      data: JSON.stringify(data),
      contentType: "application/json;charset=utf-8"
    })
    .done(function (result, status, xhr) {
      location.replace("/");
    })
    .fail(function (xhr, status, er) {
      alert("회원가입 실패");
    });
  });

  $('#adminCheck').on('click', function () {
    $('#adminPasswordForm').toggle();
  });

  function checkNickname() {
    const nickname = $('#nickname').val();

    const data = {
      nickname: nickname
    }

    // $.ajax({
    //   type: 'GET',
    //   url: '',
    //   data: data
    // })
    // .done(function (result, status, xhr) {
    //   const feedback = $('#nicknameFeedback');
    //   if (result) {
    //     feedback.text('사용 가능한 닉네임입니다.').css('color', 'green');
    //     flagNickname = true;
    //   } else {
    //     feedback.text('이미 사용 중인 닉네임입니다.').css('color', 'red');
    //   }
    // })
    // .fail(function (xhr, status, er) {
    // });
  }

  function checkEmail() {
    const email = $('#email').val();
    const emailCheck = $('#emailCheck').val();

    const data = {
      email: email,
      emailCheck: emailCheck
    }

    // $.ajax({
    //   type: 'POST',
    //   url: '', // 인증번호 확인 요청 URL
    //   data: JSON.stringify(data),
    //   contentType: "application/json;charset=utf-8"
    // })
    // .done(function (result, status, xhr) {
    //   const feedback = $('#feedbackResult');
    //   if (result.success) { // 성공 시
    //     feedback.text('성공').css('color', 'green');
    //     feedbackResult = true;
    //     $.closeTime(); // 타이머 중지
    //   } else { // 실패 시
    //     feedback.text('실패').css('color', 'red');
    //     feedbackResult = false;
    //   }
    // })
    // .fail(function (xhr, status, er) {
    //   const feedback = $('#feedbackResult');
    //   feedback.text('실패').css('color', 'red');
    //   feedbackResult = false;
    // });
  }

  let countTime = 180; // 3분 (180초)

  $.time = function(time){
    countTime = time;
    intervalCall = setInterval(alertFunc, 1000);
  }

  $.closeTime = function(){
    clearInterval(intervalCall);
  }

  function alertFunc() {
    if (countTime <= 0) {
      $.closeTime();
      alert("인증 시간이 만료되었습니다.");
      $('#countDown').text("0:00");
      return;
    }

    countTime--;

    const minutes = Math.floor(countTime / 60);
    const seconds = countTime % 60;
    $('#countDown').text(`${minutes}:${seconds < 10 ? '0' : ''}${seconds}`);
  }

  function sendEmail() {
    // 기존 타이머가 있을 경우 중지
    if (intervalCall) {
      $.closeTime();
    }

    // 이메일 인증 요청 코드를 여기에 추가합니다.

    // 타이머 시작
    $.time(180);
  }
</script>

</body>
</html>