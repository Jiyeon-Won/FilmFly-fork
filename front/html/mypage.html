<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>FilmFly</title>
  <!-- 부트 스트랩 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
        rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
        crossorigin="anonymous">
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <!-- 공통 헤더 -->
  <script src="../js/common.js"></script>
  <!-- Font Awesome -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
  <script src="../js/apiModule.js"></script>

  <link rel="stylesheet" href="../css/reset.css">
  <link rel="stylesheet" href="../css/style.css">
  <style>
    .profile-header {
      background: linear-gradient(135deg, #6e8efb, #a777e3);
      color: white;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .profile-picture {
      width: 150px;
      height: 150px;
      border-radius: 50%;
      object-fit: cover;
      border: 5px solid white;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .profile-info {
      flex-grow: 1;
      margin-left: 20px;
    }

    .profile-info h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
    }

    .profile-info p {
      font-size: 1.2rem;
      margin-bottom: 0;
    }

    .profile-info button {
      margin-top: 10px;
    }
    .btn-light{
      margin-left: 460px;
    }
    .nickname-section {
      margin-bottom: 20px;
    }

    .introduce-section {
      border-top: 1px solid white;
      padding-top: 10px;
    }
  </style>
</head>
<body>
<div class="container mt-5">
  <!-- 공통 헤더 -->
  <header id="common-header"></header>

  <div id="user-info" style="display: none;" class="mb-3">
    <div class="d-flex align-items-center">
      <div class="me-3">
        <img id="user-profile-picture" src="../images/profileImg.png" class="img-profile-big-size"
             alt="프로필 사진">
      </div>
      <div id="user-nickname" class="fs-5 fw-bold"></div>
    </div>
    <div class="mt-2">
      <p class="fw-bold">한줄 소개</p>
      <p id="user-introduce">등록된 소개가 없습니다.</p>
    </div>
  </div>

  <div id="mypage-content" class="mb-3">
    <div class="d-flex align-items-center">
      <div class="me-3">
        <img id="profile-picture" src="../images/profileImg.png" class="img-profile-big-size"
             alt="프로필 사진">
      </div>
      <div id="nickname">
        <!-- 닉네임이 표시될 곳 -->
      </div>
      <div class="d-flex justify-content-end flex-grow-1">
        <button class="btn btn-primary" onclick="location.href='./mypage-update.html'">수정</button>
      </div>
    </div>
    <div class="mt-2">
      <p class="fs-5 fw-bold">한줄 소개</p>
      <p class="p-3" id="introduce">${user.introduce}</p>
    </div>
  </div>

  <div class="card w-100 my-5">
    <ul class="list-group list-group-flush">
      <li class="list-group-item">
        <div id="btnActiveUser" class="d-flex justify-content-between" style="padding: 12px 0; cursor:pointer;">
          <span style="font-size: 20px; color: red">탈퇴한 계정 복구하기</span>
          <div>
            <!--            <span>12</span>-->
            <i class="fa-solid fa-chevron-right"></i>
          </div>
        </div>
      </li>
    </ul>
  </div>

    <div class="card w-100 mb-3">
      <ul class="list-group list-group-flush">
        <li class="list-group-item">
          <a id="collection-link" href="#">
            <span>영화 보관함</span>
            <div>
              <i class="fa-solid fa-chevron-right"></i>
            </div>
          </a>
        </li>
      </ul>
    </div>

    <div class="card w-100 mb-3">
      <ul class="list-group list-group-flush">
        <li class="list-group-item">
          <a id="review-link" href="#">
            <span>작성한 리뷰</span>
            <div>
              <i class="fa-solid fa-chevron-right"></i>
            </div>
          </a>
        </li>
        <li class="list-group-item">
          <a id="board-link" href="#">
            <span>작성한 게시물</span>
            <div>
              <i class="fa-solid fa-chevron-right"></i>
            </div>
          </a>
        </li>
        <li class="list-group-item">
          <a id="comment-link" href="#">
            <span> 작성한 댓글</span>
            <div>
              <i class="fa-solid fa-chevron-right"></i>
            </div>
          </a>
        </li>
      </ul>
    </div>

    <div class="card w-100 mb-3">
      <ul class="list-group list-group-flush">
        <li class="list-group-item">
          <a id="favorite-movie-link" href="#">
            <span>찜한 영화 목록</span>
            <div>
              <i class="fa-solid fa-chevron-right"></i>
            </div>
          </a>
        </li>
        <li class="list-group-item">
          <a id="good-link" href="#">
            <span>좋아요</span>
            <div>
              <i class="fa-solid fa-chevron-right"></i>
            </div>
          </a>
        </li>
        <li class="list-group-item">
          <a id="bad-link" href="#">
            <span>싫어요</span>
            <div>
              <i class="fa-solid fa-chevron-right"></i>
            </div>
          </a>
        </li>
      </ul>
    </div>

    <div class="card w-100 mb-3">
      <ul class="list-group list-group-flush">
        <li class="list-group-item">
          <a id="coupon-link" href="#">
            <span>받은 쿠폰 확인</span>
            <div>
              <i class="fa-solid fa-chevron-right"></i>
            </div>
          </a>
        </li>
      </ul>
    </div>

    <div class="card w-100 mb-3">
      <ul class="list-group list-group-flush">
        <li class="list-group-item">
          <a id="block-link" href="#">
            <span>차단 목록</span>
            <div>
              <i class="fa-solid fa-chevron-right"></i>
            </div>
          </a>
        </li>
      </ul>
    </div>

    <div class="card w-100 mb-3">
      <ul class="list-group list-group-flush">
        <li class="list-group-item">
          <div id="btnWithdraw" class="d-flex justify-content-between"
               style="padding: 12px 0; cursor:pointer;">
            <span>회원탈퇴</span>
            <div>
              <i class="fa-solid fa-chevron-right"></i>
            </div>
          </div>
        </li>
      </ul>
    </div>
  </div>
</div>

<div class="container">
  <!-- 컨테이너의 내용 -->

  <!-- 비밀번호 입력 모달 -->
  <div id="passwordModal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:white; padding:20px; box-shadow:0px 0px 10px rgba(0,0,0,0.1);">
    <div style="display: flex; align-items: center;">
      <label for="passwordInput" style="margin-right: 10px;">비밀번호를 입력해주세요:</label>
      <input type="password" id="passwordInput" class="form-control" style="width: 200px; margin-right: 10px;"/>
      <button id="confirmPassword" class="btn btn-primary" style="margin-right: 10px;">확인</button>
      <button id="cancelPassword" class="btn btn-secondary">취소</button>
    </div>
  </div>
</div>
<script>
  $(document).ready(function () {
    let urlParams = new URLSearchParams(window.location.search);
    let userId = urlParams.get('user');

    if (userId) {
      // 쿼리 파라미터에 유저 ID가 있을 경우 (다른 유저의 프로필 정보 조회)
      apiModule.GET(`/users/${userId}`, function (response) {
        const data = response.data;

        // 간략한 유저 정보 표시
        $('#user-profile-picture').attr('src', data.pictureUrl || '../images/profileImg.png');
        $('#user-nickname').text(data.nickname);
        $('#user-introduce').text(data.introduce || "등록된 소개가 없습니다.");

        // 간략한 유저 정보 창을 표시하고 마이페이지 내용을 숨김
        $('#user-info').show();
        $('#mypage-content').hide();
        $('#mypage-details').hide();
      }, function () {
        alert("상대방 유저 정보를 불러오는데 실패했습니다.");
      });
    } else {
      // 본인 마이페이지 정보 조회
      apiModule.GET("/users/myInfo", function (response) {
        const data = response.data;

        // 프로필 이미지 설정
        $('#profile-picture').attr('src', data.pictureUrl || '../images/profileImg.png');

        // 닉네임 설정
        $('#nickname').text(data.nickname);

        // 한줄 소개 설정(nullable = true)
        $('#introduce').text(data.introduce || "등록된 소개가 없습니다.");

        // 동적 링크 설정
        $('#collection-link').attr('href', `./mypage-collection.html?user=${data.id}`);
        $('#review-link').attr('href', `./mypage-review.html?user=${data.id}`);
        $('#board-link').attr('href', `./mypage-board.html?user=${data.id}`);
        $('#comment-link').attr('href', `./mypage-comment.html?user=${data.id}`);
        $('#favorite-movie-link').attr('href', `./mypage-favorite-movie.html?user=${data.id}`);
        $('#good-link').attr('href', `./mypage-good.html?user=${data.id}`);
        $('#bad-link').attr('href', `./mypage-bad.html?user=${data.id}`);
        $('#coupon-link').attr('href', `./mypage-coupon.html?user=${data.id}`);
        $('#block-link').attr('href', `./mypage-block.html?user=${data.id}`);
      }, function () {
        alert("유저 정보를 불러오는데 실패했습니다.");
      });
    }

    $('#btnWithdraw').on('click', function () {
      if (confirm('정말로 탈퇴하시겠습니까?')) {
        // 비밀번호 입력 모달 표시
        $('#passwordModal').show();

        // 비밀번호 입력 후 엔터 키 눌렀을 때 확인 버튼 클릭 처리
        $('#passwordInput').on('keypress', function (e) {
          if (e.which === 13) { // 13은 Enter 키의 코드 값입니다.
            $('#confirmPassword').click(); // 확인 버튼 클릭 이벤트 트리거
          }
        });

        $('#confirmPassword').on('click', function () {
          let password = $('#passwordInput').val();
          if (password) {
            $('#passwordModal').hide(); // 입력 모달 숨기기

            // 비밀번호를 서버로 전송
            apiModule.DELETE('/users/withdraw', { password: password }, function (response) {
              alert('회원 탈퇴가 완료되었습니다.');
              localStorage.setItem('isLoggedIn', 'false'); // 로그인 상태 업데이트
              localStorage.removeItem('userRole'); // 사용자 역할 정보 제거
              localStorage.removeItem('loginTime'); // 로그인 시간 제거
              location.href = './index.html'; // 탈퇴 후 메인 페이지로 리디렉션
              updateAuthLinks();
            }, function (xhr) {
              if (xhr.status === 400) {
                alert('비밀번호가 올바르지 않습니다.');
              } else {
                alert('회원 탈퇴에 실패했습니다. 다시 시도해 주세요.');
              }
            });
          }
        });

        $('#cancelPassword').on('click', function () {
          $('#passwordModal').hide(); // 취소 버튼을 누르면 모달 창 닫기
        });
      }
    });

    $('#btnActiveUser').on('click', function () {
      if (confirm('정말로 계정을 복구하시겠습니까?')) {
        // 계정 복구 요청
        apiModule.PATCH('/users/activate', null, function (response) {
          alert('계정 복구가 완료되었습니다.');
          location.href = '/film-fly/front/html/index.html'; // 복구 후 메인 페이지로 리디렉션
        }, function (xhr) {
          alert('계정 복구에 실패했습니다. 다시 시도해 주세요.');
        });
      } else {
        history.back(); // 취소 버튼 누르면 뒤로 가기
      }
    });
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-p53gCrZMH7y9K3A1/puuV4M7T7zrRX94caT9i7neZmQxHDhyb2nkvOY3Uwe1F4Tv"
        crossorigin="anonymous"></script>
</body>
</html>
